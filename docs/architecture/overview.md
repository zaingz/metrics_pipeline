# Architecture Overview

The Metrics Pipeline is designed with extensibility and scalability in mind, following a modular architecture based on the adapter pattern. This document provides an overview of the system architecture and how the different components interact.

## High-Level Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Data Sources   │────▶│    Ingestion    │────▶│    Storage      │────▶│  Visualization  │
│                 │     │    Adapters     │     │    Adapters     │     │    Adapters     │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
                               │                       │                       │
                               │                       │                       │
                               ▼                       ▼                       ▼
                        ┌─────────────────────────────────────────────────────────────┐
                        │                                                             │
                        │                    Core Pipeline                            │
                        │                                                             │
                        └─────────────────────────────────────────────────────────────┘
```

## Components

### 1. Data Sources

These are the origins of metrics data, which can include:
- Web applications (page views, clicks)
- Mobile applications
- Server applications
- IoT devices
- Any system generating metrics

### 2. Ingestion Adapters

Ingestion adapters are responsible for receiving metrics data from various sources and forwarding them to the pipeline for processing. The system includes:

- **Base Adapter Interface**: Defines the contract for all ingestion adapters
- **SQS Adapter**: Ingests metrics via AWS SQS queues
- **HTTP Adapter**: Ingests metrics via HTTP API endpoints

### 3. Storage Adapters

Storage adapters handle the persistence of metrics data, providing query and aggregation capabilities:

- **Base Adapter Interface**: Defines the contract for all storage adapters
- **ClickHouse Adapter**: Stores metrics in ClickHouse for high-performance analytics
- **In-Memory Adapter**: Stores metrics in memory for testing and development

### 4. Visualization Adapters

Visualization adapters connect to visualization tools to create dashboards and charts:

- **Base Adapter Interface**: Defines the contract for all visualization adapters
- **Metabase Adapter**: Integrates with Metabase for creating dashboards and visualizations
- **Mock Adapter**: Provides a mock implementation for testing

### 5. Core Pipeline

The core pipeline orchestrates the flow of data between adapters:

- **MetricsPipeline**: Coordinates the ingestion, processing, and storage of metrics
- **Models**: Defines the data structures used throughout the pipeline

## Data Flow

1. Metrics data is generated by various sources
2. Ingestion adapters receive the data and validate it
3. The core pipeline processes the data
4. Storage adapters persist the data
5. Visualization adapters create dashboards and visualizations

## Deployment Options

The system supports multiple deployment options:

### AWS Deployment

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Client Apps    │────▶│  API Gateway    │────▶│  SQS Queue      │────▶│  EC2/ECS Worker │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
                                                                                │
                                                                                │
                                                                                ▼
                                                                        ┌─────────────────┐
                                                                        │                 │
                                                                        │   ClickHouse    │
                                                                        │                 │
                                                                        └─────────────────┘
                                                                                │
                                                                                │
                                                                                ▼
                                                                        ┌─────────────────┐
                                                                        │                 │
                                                                        │    Metabase     │
                                                                        │                 │
                                                                        └─────────────────┘
```

### Local Development

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Test Client    │────▶│  LocalStack     │────▶│  Local Worker   │────▶│  ClickHouse     │
│                 │     │                 │     │                 │     │  Container      │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
                                                                                │
                                                                                │
                                                                                ▼
                                                                        ┌─────────────────┐
                                                                        │                 │
                                                                        │    Metabase     │
                                                                        │    Container    │
                                                                        └─────────────────┘
```

## Extensibility

The adapter pattern allows for easy extension of the system:

1. **New Ingestion Sources**: Implement a new ingestion adapter
2. **Alternative Storage Backends**: Implement a new storage adapter
3. **Different Visualization Tools**: Implement a new visualization adapter

Each adapter type follows a well-defined interface, making it straightforward to add support for new technologies while maintaining compatibility with the core pipeline.
